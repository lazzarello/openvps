#
# Copyright 2004 OpenHosting, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# $Id: dft.py.in,v 1.29 2009/01/21 01:41:50 grisha Exp $

""" Configuration Defaults

DO NOT EDIT THIS FILE. To change settings, edit your configuration
file. This file is by default /etc/openvps.conf (look below
for CONFIG_FILE for the exact value).

"""

import os, sys

PREFIX = '@prefix@' 

# This is sytem is live. Only live systems send heartbeats to admin.
LIVE_SYSTEM = False

# The main oh directory
OV_DIR = os.path.join(PREFIX, 'openvps')

# Configuration directory
CONFIG_DIR = '/etc'

# Configuration file
CONFIG_FILE = os.path.join(CONFIG_DIR, 'openvps.conf')

# Miscellaneous dir
MISC_DIR = os.path.join(PREFIX, 'openvps/misc')

# WWW template location
TMPL_DIR = os.path.join(PREFIX, 'openvps/templates')

# used below for values that must come from the config file
NOVAL = 'NO VALUE SET - edit %s' % CONFIG_FILE

# Location of miscellaneous files, particularly ping and traceroute
# that later on are copied into a reference vserver
OV_MISC = os.path.join(OV_DIR, 'misc')

# Version
VERSION = open('/etc/openvps-release').read().strip()

# Location of ohchkpwd script used by the web interface panel to
# verify vserver account passwords
OVCHKPWD = os.path.join(PREFIX, 'sbin', 'ovchkpwd')

# Location of ovwrapper to allow us to do special stuff
# DO NOT change this in the config, since the ovwrapper is used
# to load the config in the first place when you're not root
OVWRAPPER = os.path.join(PREFIX, 'sbin', 'ovwrapper')

# Location of vservers config and lib
ETC_VSERVERS = '/etc/vservers'  # overriden by openvps.conf
VSERVER_PREFIX = '/usr/local'   # overriden by openvps.conf

# the following is in cfg.py
#VSERVER_LIB = os.path.join(VSERVER_PREFIX, 'lib/util-vserver')
#VSERVER_STAT = os.path.join(VSERVER_PREFIX, 'sbin/vserver-stat')
#VSERVER = os.path.join(VSERVER_PREFIX, 'sbin/vserver')
#CHCONTEXT = os.path.join(VSERVER_PREFIX, 'sbin/chcontext')

# Location of context disk limit tool (vdlimit)
VDLIMIT = '@VDLIMIT@'

# The partition where vservers live
VSERVERS_ROOT = NOVAL

# Reference servers. First one is the preferred one
# XXX need to add this to openvps-configure
REFROOTS = ['/vservers/REF-CentOS5_64', '/vservers/REF-CentOS5', '/vservers/REF-FC4',
            '/vservers/REF-FC3', '/vservers/REF-FC2', '/vservers/REF-FC1']

# Location of the vservers database
# /var/db/oh will be obsoleted eventually
VAR_DB_OH = '/var/db/oh'
# this is the new location
VAR_DB_OPENVPS = '/var/db/openvps'

# name of the key file (in /var/db/openvps usually)
KEYFILE = '.key'

# Location of the backups partition
BACKUP = NOVAL

# Peer ip (the server to which we backup)
PEERIP = '127.0.0.1'

# DSA key that allows login to peer as ohbackup
OHB_DSA_KEY = '@prefix@/etc/ohbackup_dsa'

# whom to send notification that RAID has problems
# empty means don't check raid at all
NOTIFY_EMAIL = ''

# User used to login to remote server for backup
BACKUP_USER = 'ohbackup'

# Backup window. The window starts whenever the openvps cron file
# starts it, thus there is no BACKUP_START value. 
# Backups must be _started_ within this window (mins):
BACKUP_WINDOW = 180 # 3 hrs
# Period of time that separates backups (minutes). We will figure out
# the number of slices in a window, and the start time of the backup
# will fall into one of the slices, based on the last digit of the
# PRIMARY_IP.
BACKUP_SLICE = 30

# default inodes per vserever allowed
INODES_LIM = 1000000

# default rlimits for vservers, keys are filenames from
# vserver rlimits config directory
# XXX there will be more limits available in the future,
# there is socks, but no way to set it in utils, there is
# locks and msg_queue, but they are not implemented
#
# A note on memory limits:
#   they are reported in 4K pages by /proc/virtual/.../limit
#   they are NOT accurate. It is simply a sum of individual process
#   memory stats. Processes that fork() initially share their memory
#   pages, but that is not reflected (and cannot technically be
#   accounted for). Thus, it makes sense to keep these limits a tad
#   higher than seems reasonable at first. The defaults here are aimed
#   at large systems with at least 2GB of RAM or more.
#
RLIMITS = {'as': 2097152, # virtual memory limit, 8 GB
           'memlock': 409600, # locked memory, 1600MB # so large to avoid vserver bug
           'rss': 524288,   # RSS, 2GB
           'nofile': 8192,  # number of open files
           'nproc': 1024,    # number of processes
           }

# default domain name - the hostname for vservers will be
# vservername + this domain
DEFAULT_DOMAIN = 'domain.tld'

# default receiver of the mon heartbeats
MON_SECRET = 'Please change me!'
MON_TARGET_IP = '127.0.0.1'
MON_PID_FILE = '/var/run/openvps-mon.pid'

# secret for backup files (openvps dump)
DUMP_SECRET = 'Please change me too!'

# superuser userid for the OpenVPS panel
PANEL_SUPERUSER = 'openvps'
PANEL_SUPERUSER_PW = '*' # disable by default

# When cloning a reference server, these rules dictate
# what is done. Default action is to hardlink, unless
# any of the paths below match:
#  'copy' - copy files
#  'touch' - copy just the file, not its data
#  'skip' - ignore it
#
# NOTE that the config will compile these and turn CLONE_RULES
# into a triple of (copy, touch, skip) re objects.

CLONE_RULES = {
    'copy' : ['/etc', '/var', '/root', '^/dev', '/usr/share/pear'],
    'touch' : ['/var/log', '/var/run', '\.bash_history'],
    'skip' : ['ssh_host_', '.pem$', '/proc/', '/var/tmp/', '/var/cache/.*/.+'] 
    }

# location of chroot command

CHROOT = '/usr/sbin/chroot' # XXX conf

# location of rrdtool

#RRDTOOL = '/usr/bin/rrdtool' # XXX conf

# The /etc/motd file

MOTD = """

    Welcome to your new OpenHosting Virtual Server!

"""

# The initial index.html placed into the servers. This should probably
# be a page with a link to the explanation of what to do with a new
# server.

INDEX_HTML = """
    <html>
      <!-- Version %s -->
      <title>OpenVPS Virtual Server</title>
      <center>
         <h2>This site is under construction.</h2>
      </center>
      </html>
      """ % VERSION # keep emacs happy "

# Default nice.
DFT_NICE = '9' # not as nice as default (10), but nice

# Vserver flags (^19 is VIRT_LOAD)
DFT_FLAGS = 'lock\nhide_netif\nvirt_uptime\nvirt_load\nvirt_cpu\nvirt_mem\nsched_prio\nfakeinit\n'

# Scheduler parameters. This only has effect when the sched_hard flag
# is set. Every <interval> (in jiffies ~10ms), a <fill-rate> tokens is
# added to the token bucket. At each timer tick a running process
# consumes a token (to start python is ~16 tokens). If the bucket gets
# empty, the conext is placed on hold queue until <min-tokens> is in
# the bucket. A bucket can accumulate up to <max-token> tokens.
# Another important tip from Sam Vilain: fr / int * 100 = % cpu
DFT_SCHED = {'fill-rate': 30,
             'interval': 100,
             'tokens': 1000,
             'tokens-min': 30,
             'tokens-max':1000}

# Device on which vservers get their IPs
DFT_DEVICE = 'eth0'

# Traffic shaping things. This is default per-server bandwidth for all
# vservers. This means that the sum of all of vservers bandwidth is
# not to exceed this value. Note that this is only applicable to the
# vserver htb, traffic from the main server IP (xid 0) is restricted
# by another htb to 100mbit. See /etc/init.d/ovtc.

DFT_VS_RATE_TOT = '10mbit'

# The per-vserver rate and ceil. Note that the sum of all children
# must not exceed the DFT_VS_RATE_TOT. So if we plan on putting 40 or
# less VPS's on a box and the DFT_VS_RATE_TOT is 10mbit, this value is
# 10mbit / 40 = 256kbit. This does not mean that the bandwith is
# restricted to this, the restriction is the ceil parameter. This is
# in effect the guaranteed rate.

DFT_VS_RATE = '256kbit'

# This is the default per-server ceiling. A vps can never exceed this.

DFT_VS_CEIL = '5mbit'

# This is a cap on how high the users are allowed to set their
# bandwidth from the OpenVPS control panel, _in bits_.

DFT_VS_RATE_CAP = 52428800 # 5mbit

# Which "commands" are allowed to run with elevated capabilities and
# what are those caps. The path is absolute inside a vserver.
# Capability names can be found in /usr/include/linux/capability.h

COMMAND_CAPS = {
    # ping already works in 1.9.3 without special tricks
    'TRACEROUTE' : ['/usr/libexec/openvps/traceroute', ['NET_RAW']],
    # mount/umount work too
    #'MOUNT_BIND': ['/usr/libexec/oh/mount', ['SYS_ADMIN']],
    #'UMOUNT': ['/usr/libexec/oh/umount', ['SYS_ADMIN']],
    }

# The username used for the commands above
OHD_USER = '@OHD_USER@'

# The port on which sshd listens for these commands
OHD_PORT = '@OHD_PORT@'

# services we want enabled (everything else is disabled)
FEDORA_C2_SRVCS =  ['crond', 'atd', 'httpd', 'sendmail', 'sshd',
                   'syslog', 'webmin', 'dovecot']
# these aren't really services, but are in /etc/init.d
FEDORA_C2_NOT_SRVCS = ['functions', 'killall', 'halt', 'single']

# How many IO intensive operations (e.g. during cloning) we do before
# sleeping. (ops, seconds)

PACE = (1000, 0)

# temporary location on the host server to store remote RPM's
RPM_CACHE = '/var/tmp/openvps-rpmcache'

# This a dictionary with three lists: BASE (I and II) and ADDL.
# BASE is installed first, then ADDTL.


FEDORA_PKGS_ADDL = [ ]

# FC3 stuff
# just use these insted in vds.py to build an FC3 server

FEDORA_PKGS_BASE_I = [
    'SysVinit',
    'acl',
    'anacron',
    'apr',
    'apr-devel',
    'apr-util',
    'ash',
    'aspell',
    'aspell-en',
    'at',
    'attr',
    'authconfig',
    'basesystem',
    'bash',
    'bc',
    'beecrypt',
    'bind-libs',
    'bind-utils',
    'bzip2',
    'bzip2-libs',
    'chkconfig',
    'coreutils',
    'cpio',
    'cracklib',
    'cracklib-dicts',
    'crontabs',
    'cups-libs',
    'cyrus-sasl',
    'cyrus-sasl-md5',
    'db4',
    'diffutils',
    'dos2unix',
    'e2fsprogs',
    'ed',
    'elfutils',
    'elfutils-libelf',
    'ethtool',
    'expat',
    'fedora-release',
    'file',
    'filesystem',
    'findutils',
    'finger',
    'ftp',
    'gawk',
    'gdbm',
    'glib',
    'glib2',
    'glibc',
    'glibc-common',
    'gmp',
    'gnupg',
    'gpm',
    'grep',
    'groff',
    'gzip',
    'hesiod',
    'htmlview',
    'http://www.openvps.org/dist/misc/openvps-bogus-kernel-2.9.0-2.i386.rpm',
    'httpd',
    'httpd-suexec',
    'info',
    'initscripts',
    'iproute',
    'iputils',
    'jwhois',
    'krb5-libs',
    'less',
    'lftp',
    'lha',
    'libacl',
    'libattr',
    'libgcc',
    'libgcrypt',
    'libgpg-error',
    'libjpeg',
    'libpng',
    'libselinux',
    'libsepol',
    'libstdc++',
    'libtermcap',
    'libtiff',
    'libuser',
    'libwvstreams',
    'libxml2',
    'libxml2-python',
    'logrotate',
    'logwatch',
    'lrzsz',
    'lsof',
    'm4',
    'mailcap',
    'mailx',
    'make',
    'man',
    'man-pages',
    'mingetty',
    'mkinitrd',
    'mktemp',
    'module-init-tools',
    'mtr',
    'nano',
    'nc',
    'ncurses',
    'net-tools',
    'newt',
    'nscd',
    'nss_ldap',
    'ntsysv',
    'openldap',
    'openssh',
    'openssh-clients',
    'openssh-server',
    'openssl',
    'pam',
    'passwd',
    'pax',
    'pcre',
    'pcre-devel',
    'perl',
    'perl-Filter',
    'pinfo',
    'popt',
    'portmap',
    'procmail',
    'procps',
    'psacct',
    'psmisc',
    'pyOpenSSL',
    'python',
    'rdist',
    'readline',
    'redhat-menus',
    'rootfiles',
    'rpm',
    'rpm-libs',
    'rpm-python',
    'rsh',
    'rsync',
    'sed',
    'sendmail',
    'setup',
    'setuptool',
    'shadow-utils',
    'slang',
    'slocate',
    'specspo',
    'star',
    'stunnel',
    'sudo',
    'symlinks',
    'sysklogd',
    'talk',
    'tar',
    'tcp_wrappers',
    'tcsh',
    'telnet',
    'termcap',
    'time',
    'tmpwatch',
    'traceroute',
    'traceroute',
    'tzdata',
    'unix2dos',
    'unzip',
    'usermode',
    'utempter',
    'util-linux',
    'vim-common',
    'vim-minimal',
    'vixie-cron',
    'wget',
    'which',
    'words',
    'yum',
    'zip',
    'zlib',
]


FEDORA_PKGS_BASE_II = [
    'Glide3',
    'Xaw3d',
    'apr-util-devel',
    'atk',
    'atk-devel',
    'autoconf',
    'automake',
    'bind-chroot',
    'binutils',
    'chkfontpath',
    'cpp',
    'curl',
    'curl-devel',
    'cvs',
    'cyrus-sasl-devel',
    'db4-devel',
    'dbh',
    'desktop-backgrounds-basic',
    'distcache',
    'dovecot',
    'e2fsprogs-devel',
    'emacs',
    'emacs-common',
    'expat-devel',
    'fetchmail',
    'fontconfig',
    'fontconfig-devel',
    'fonts-xorg-base',
    'freetype',
    'freetype-devel',
    'gcc',
    'gcc-c++',
    'gd',
    'gd-devel',
    'gdbm-devel',
    'glib-devel',
    'glib2-devel',
    'glibc-devel',
    'glibc-headers',
    'glibc-kernheaders',
    'gtk2',
    'gtk2-devel',
    'http://www.openvps.org/dist/misc/mirror/perl-Net-SSLeay-1.23-0.rhfc1.dag.i386.rpm',
    'http://www.openvps.org/dist/misc/mirror/perl-Net-SSLeay-1.23-0.rhfc1.dag.i386.rpm',
    'http://www.openvps.org/dist/misc/mirror/proftpd-1.2.9-7.i386.rpm',
    'http://www.openvps.org/dist/misc/oh-bind-9.2.4-2.i386.rpm',
    'http://www.openvps.org/dist/misc/webmin-1.170-1_OH.noarch.rpm',
    'httpd-devel',
    'krb5-devel',
    'libc-client',
    'libidn',
    'libstdc++-devel',
    'libtool',
    'libtool-libs',
    'libungif',
    'libxfce4mcs',
    'libxfce4mcs-devel',
    'libxfce4util',
    'libxfcegui4',
    'libxslt',
    'lynx',
    'mod_perl',
    'mod_perl-devel',
    'mod_python',
    'mod_ssl',
    'mx',
    'mysql',
    'mysql-devel',
    'mysql-server',
    'openldap-devel',
    'openssl-devel',
    'pango',
    'pango-devel',
    'patch',
    'perl-DBD-MySQL',
    'perl-DBD-Pg',
    'perl-DBI',
    'perl-Digest-HMAC',
    'perl-Digest-SHA1',
    'perl-HTML-Parser',
    'perl-HTML-Tagset',
    'perl-Net-DNS',
    'perl-Time-HiRes',
    'perl-URI',
    'perl-XML-Parser',
    'perl-libwww-perl',
    'php',
    'php-devel',
    'php-domxml',
    'php-imap',
    'php-ldap',
    'php-mysql',
    'php-pear',
    'php-pgsql',
    'php-xmlrpc',
    'php-gd',
    'pkgconfig',
    'postgresql',
    'postgresql-contrib',
    'postgresql-devel',
    'postgresql-docs',
    'postgresql-jdbc',
    'postgresql-libs',
    'postgresql-pl',
    'postgresql-python',
    'postgresql-server',
    'postgresql-tcl',
    'postgresql-test',
    'python-devel',
    'rcs',
    'rpm-build',
    'rpm-devel',
    'samba',
    'samba-client',
    'samba-common',
    'samba-swat',
    'screen',
    'spamassassin',
    'squid',
    'startup-notification',
    'switchdesk',
    'tcl',
    'tcl-devel',
    'telnet-server',
    'tk',
    'ttmkfdir',
    'vim-enhanced',
    'vnc-server',
    'webalizer',
    'xfce-mcs-manager',
    'xfce-mcs-manager-devel',
    'xfce-mcs-plugins',
    'xfce-utils',
    'xfce4-panel',
    'xfdesktop',
    'xffm',
    'xffm-icons',
    'xfwm4',
    'xfwm4-themes',
    'xinetd',
    'xinitrc',
    'xorg-x11',
    'xorg-x11-Mesa-libGL',
    'xorg-x11-Mesa-libGLU',
    'xorg-x11-devel',
    'xorg-x11-font-utils',
    'xorg-x11-libs',
    'xorg-x11-tools',
    'xorg-x11-xauth',
    'xorg-x11-xfs',
    'xterm',
    'zlib-devel',
    ]

# The organization name for the SSL cert. This is your company name
# and other info.

SSL_ORG_COUNTRY = "US"
SSL_ORG_STATE = "Virginia"
SSL_ORG_NAME = "Some Company, Inc."

SSL_CONFIG = """
HOME= .
RANDFILE = $ENV::HOME/.rnd

[ req ]
default_bits = 1024
encrypt_key = yes
distinguished_name = req_dn
x509_extensions = cert_type

[ req_dn ]
countryName = Country Name (2 letter code)
countryName_default             = NO
countryName_min                 = 2
countryName_max                 = 2
countryName_value               = %s

stateOrProvinceName             = State or Province Name (full name)
stateOrProvinceName_default     = Some-State
stateOrProvinceName_value       = %s

localityName                    = Locality Name (eg, city)
localityName_value              = Vienna

0.organizationName              = Organization Name (eg, company)
0.organizationName_default      = FooBar Inc.
0.organizationName_value        = %s

organizationalUnitName          = Organizational Unit Name (eg, section)
organizationalUnitName_value    = Security Department

0.commonName                    = Common Name (FQDN of your server)
0.commonName_value              = @SSL_HOSTNAME@

1.commonName                    = Common Name (default)
1.commonName_value              = localhost

[ cert_type ]
nsCertType = server
""" % (SSL_ORG_COUNTRY, SSL_ORG_STATE, SSL_ORG_NAME)

HTTPD_CONF = """
<IfModule mod_proxy.c>
  # OpenHosting panel proxy
  ProxyRequests           Off
  ProxyPass               /ohadmin/ http://127.0.0.1:1011/
  ProxyPassReverse        /ohadmin/ http://127.0.0.1:1011/
</IfModule>
"""

RNDSLEEP = """\
#!/bin/bash

# (c) 2004 OpenHosting, Inc.

sleep $(($RANDOM %  ${1:-1}))

"""

CRONTAB = """\
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin
MAILTO=root
HOME=/

#
# NOTE the rndsleep command will sleep a random number of seconds for
# up to the argument given. It is there to prevent virtual servers from
# doing heavy disk IO all at the same time.
#
# BE COURTEOUS, LEAVE IT THERE.
#
01 * * * * root rndsleep 60 && run-parts /etc/cron.hourly
02 4 * * * root rndsleep 1200 && run-parts /etc/cron.daily
22 4 * * 0 root rndsleep 1200 && run-parts /etc/cron.weekly
42 4 1 * * root rndsleep 1200 && run-parts /etc/cron.monthly
"""

HB = 300 # default heart beat

# RRD datapoints definition for per-vserver stats
# (name, rrd_type, hbeat, min, max)
VSMON_DATA_DEF = [('vs_procs', 'gauge', HB, 0, 'U'), # number of procs 
                  ('vs_procs_lim', 'gauge', HB, 0, 'U'), 
                  ('vs_procs_lhits', 'gauge', HB, 0, 'U'), 
                  ('vs_vm', 'gauge', HB, 0, 'U'),    # total memory
                  ('vs_vm_lim', 'gauge', HB, 0, 'U'), 
                  ('vs_vm_lhits', 'gauge', HB, 0, 'U'), 
                  ('vs_vml', 'gauge', HB, 0, 'U'),   # locked memory
                  ('vs_vml_lim', 'gauge', HB, 0, 'U'), 
                  ('vs_rss', 'gauge', HB, 0, 'U'),   # rss
                  ('vs_rss_lim', 'gauge', HB, 0, 'U'), 
                  ('vs_uticks', 'counter', HB, 0, 10000), 
                  ('vs_sticks', 'counter', HB, 0, 10000), 
                  ('vs_hticks', 'counter', HB, 0, 10000),
                  ('vs_ipc_totshm', 'gauge', HB, 0, 'U'),
                  ('vs_ipc_totsem', 'gauge', HB, 0, 'U'),
                  ('vs_in', 'counter', HB, 0, 0xFFFFFF00L), 
                  ('vs_out', 'counter', HB, 0, 0xFFFFFF00L), 
                  ('vs_disk_b_used', 'gauge', HB, 0, 'U'), 
                  ('vs_disk_b_total', 'gauge', HB, 0, 'U'), 
                  ('vs_disk_i_used', 'gauge', HB, 0, 'U'), 
                  ('vs_disk_i_total', 'gauge', HB, 0, 'U'), 
                  ]

# The default vserver fstab file. This can be overriden in the config
# file if you want additional mounts created. This is what ends up in
# /etc/vservers/<vps>/fstab file at VPS creation time.

VS_FSTAB = 'none                    /dev/pts                devpts  gid=5,mode=620  0 0\n' \
           'none                    /proc                   proc    defaults        0 0\n'

# The /etc/fstab file _inside_ the VPS. This file is cosmetic - it
# does not cause any mounts, for that see VS_FSTAB.

FSTAB = '/dev/hdv1  /       ext2    defaults  1       1\n'

# makes emacs go into python mode
### Local Variables:
### mode:python
### End:
